# Для чего этот скрипт

Этот скрипт предназначен для автоматической обработки входящих писем (с вопросами от клиентов WB) на почтовом ящике и отправки ответов через API Wildberries. Скрипт проверяет непрочитанные письма, извлекает необходимую информацию и отправляет ответы или отклоняет вопросы в зависимости от содержания письма. <br>
Скрипт предназначен для работы в паре с репозиторием [Wildberries-QuestionsSeller-EmailSender]() (сначала формируются письма с вопросами, отправляются на почту сотрудника (или проект для обработки вопросов), который их обрабатывает. Затем данный скрипт проверяет почту и отправляет ответы по API. Скрипт создавался, чтобы ослеживать среднее время ответа, количество обработанных вопросов)

______

## Начало работы

* [Какое письмо будет искать скрипт](#какое-письмо-будет-обрабатывать-скрипт)  
* [Создание функции](#создание-функции)
* [Настройка триггера](#настройка-триггера)  
* [Запуск скрипта](#запуск-скрипта)  
* [Как работает скрипт](#как-работает-скрипт)  
* [Важные замечания](#важные-замечания)  

## Какое письмо будет обрабатывать скрипт

В заголовке письма после "Re:" должен стоять id вопроса Wildberries<br>
В теле письма первая строка должна содержать `[Ответить]_____` - если отвечаем на вопрос (или `[Отклонить]_____` -  если пропускаем вопрос)<br>
![image](https://github.com/user-attachments/assets/94f99baa-1422-4009-b38e-0c22c7ab7cbf)



## Создание функции

1. Необходимо создать функцию python на [Yandex Cloud Functions](https://console.yandex.cloud/folders) <br>
2. Заменить содержимое файла `index.py` в вашей функции на содержимое файла `index.py` из данного репозитория<br>
3. Создать в функции 4 файла - `API_send_answer.py`,`login.py`,`mail_read.py` и `requirements.txt`, вставить в них содержимое файлов `API_send_answer.py`,`login.py`,`mail_read.py` и `requirements.txt` из данного репозитория.<br>
5. Перед запуском скрипта необходимо настроить параметры в файле `login.py`:<br>
`api_key`: API-ключ для доступа к API Wildberries. Этот ключ необходим для отправки ответов на вопросы.<br>
`imap_server`: Сервер для подключения к почте (например, imap.mail.ru).<br>
`imap_username`: Почта, которую необходимо проверять на входящие письма.<br>
`imap_password`: Пароль от почты для сторонних приложений.<br>
`trusted_mail`: Почта, с которой будут поступать письма. Важно соблюдать регистр символов.<br>

6. В настройках функции установить таймаут 60 секунд и сохранить изменения<br>
![image](https://github.com/user-attachments/assets/7b72ff96-543e-4886-9ad9-751239dee50f) 
7. Сделать функцию публичной переключив тумблер в обзоре функции<br>
![image](https://github.com/user-attachments/assets/251ebed7-2ee7-4a82-87cb-db9e51597b18)


## Настройка триггера

Создать триггер, который будет запускать функцию каждые 15 минут (время на ваше усмотрение)<br>
![image](https://github.com/user-attachments/assets/84fcbbf3-58c6-4e24-9e97-7a6b8b90fa14)


## Запуск скрипта

Для запуска скрипта необходимо:
1.	Зайти на [Yandex Cloud Functions](https://console.yandex.cloud/folders) 
2.	Перейти в триггеры <br>
![image](https://github.com/user-attachments/assets/c133a1b2-3391-412f-ad8c-d323d5c13b1f)

3.	Кликнуть по триггеру <br>
![image](https://github.com/user-attachments/assets/022810c2-777f-4802-8244-7c61007b2f22)

4.	В правом верхнем углу нажать кнопку «Запустить»: <br>
![image](https://github.com/user-attachments/assets/96b367a9-c0ab-48a2-950a-5b31ea64a328) <br>
Подтвердить действие: <br>
![image](https://github.com/user-attachments/assets/96f6b7ff-4808-4a87-afa2-d34546aa0464)
5.	Скрипт запущен (будет проверять почту на новые письма каждые 15 минут, при нахождении нужного письма отправлять ответ на вопрос по API Wildberries)


## Как работает скрипт
Проверка писем: Скрипт подключается к почтовому серверу и проверяет папку "INBOX" на наличие непрочитанных писем.<br>
Обработка писем: Если письмо отправлено с доверенного адреса, скрипт извлекает тему письма и его содержимое.<br>
Отправка ответа: В зависимости от содержания письма (например, `[Ответить]_____` или `[Отклонить]_____`), скрипт отправляет соответствующий запрос через API Wildberries.<br>
Повторная попытка: Если запрос к API завершается ошибкой, скрипт делает до 3 попыток отправки с интервалом в 10 секунд.<br>
Пометка писем: Если отправка ответа завершилась ошибкой, письмо помечается как непрочитанное для повторной обработки.

## Важные замечания
Убедитесь, что почтовый ящик, указанный в `imap_username`, поддерживает IMAP-подключение.<br>
Пароль для почтового ящика должен быть паролем для сторонних приложений, если используется почта Mail.ru.<br>
Скрипт обрабатывает только письма от доверенного адреса, указанного в `trusted_mail`.
